<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sales Dashboard</title>
</head>
<style>
    body{
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
        color: black;
        transition: all 0.3s ease;
    }
    /* Header t·ªïng th·ªÉ */
        .head {
        display: flex;
        justify-content: space-between;  /* chia 2 b√™n */
        align-items: center;
        padding: 16px 28px;
        background: var(--header-bg, #ffffff);
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    /* Ti√™u ƒë·ªÅ b√™n tr√°i */
    .head h2 {
        margin: 0;
        font-size: 26px;
        font-weight: 700;
        color: var(--text-color, #333);
        letter-spacing: 0.5px;
    }

    /* C·ª•m Dark Mode b√™n ph·∫£i */
    .theme-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #theme-label {
        font-size: 15px;
        color: var(--text-color, #333);
    }

    .dark-mode .theme-toggle {
        background-color: gray;
    }

    .dark-mode .theme-toggle #theme-label{
        color: white;
    }
    .dark-mode .head {
        background-color: black;
        color: white;
    }
    .dark-mode .head h2{
        color: white;
    }

    .dark-mode{
        background-color: #121212;
        color: white;
    }

    .theme-toggle {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background-color: #007BFF;
        color: white;
        font-size: 14px;
        margin-left: 10px;
        transition: 0.3s;
    }

    .theme-toggle:hover {
        background-color: #0056b3;
    }
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
    margin-left: 15px;
    vertical-align: middle;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0;
    right: 0; bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 22px; width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #007BFF;
}

input:checked + .slider:before {
    transform: translateX(22px);
}


    .dashboard-parameters div {
        border-radius: 8px;
        padding: 10px;
        margin: 5px;
        display: inline-block;
        text-align: center;
        min-width: 150px;
        background-color: #f0f0f0;
        transition: background-color 0.3s;
    }

    .dark-mode .dashboard-parameters div {
        background-color: #1e1e1e;
    }

    .dark-mode .dashboard-parameters .parameter-card h5 {
        color: #f0f0f0;
    }

    .dark-mode .filter-bar {
        background-color: #1e1e1e;
        color: white;
    }

    .dark-mode .time-update b {
        color: white;
    }

    .dark-mode .chart-card {
        background-color: #1e1e1e;
    }

    header{
        background-color: #1f77b4;
        color: white;
        padding: 15px 30px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }

    .filter-bar{
        background: #fff;
        margin: 20px;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }

    .filter-bar label {
        font-weight: bold;
    }

    .filter-bar select, .filter-bar button {
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #f9f9f9;
    }

    .filter-bar button{
        background: #1f77b4;
        color: white;
        cursor: pointer;
        border: none;
    }

    .filter-bar button:hover{
        background: #155b8a;
    }

    .btn-reset{
        background: #aaa;
    }

    .btn-reset:hover{
        background: #888;
    }

    .btn-export{
        background: #2ca02c;
    }

    .btn-export:hover{
        background: #1d7e1d;
    }
    .dashboard-grid{
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        padding: 20px;
    }

    .chart-card{
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 10px;
        height: 450px;
    }
    /* Responsive: if the smaller 768px to tranfer 1 chart in the each row*/
    @media (max-width: 768px){
        .dashboard-grid{
            grid-template-columns: 1fr;
        }
    }
    .dashboard-parameters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 20px;
        margin: 20px 0;
        padding: 10px;
    }
    .parameter-card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        padding: 15px 10px;
        transition: all 0.3s ease;
    }
    .parameter-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .parameter-card h5 {
        margin-bottom: 8px;
        font-size: 15px;
        color: #555;
        font-weight: 600;
    }

    .parameter-card p {
        font-size: 20px;
        font-weight: bold;
        color: #1a73e8;
        margin: 0;
    }

    @media (max-width: 768px) {
        .parameter-card p {
            font-size: 18px;
        }
    }


</style>
<body>
   <div class="head">
    <h2>Financial Dashboard</h2>
    <div class="theme-toggle">
        <span id="theme-label">üåô Dark Mode</span>
        <label class="switch">
            <input type="checkbox" id="theme-switch" onchange="toggleTheme()" {% if theme == 'dark' %} checked {% endif %}>
            <span class="slider"></span>
        </label>
    </div>
</div>
    </div>
    <form method="POST" id="filterForm">
        <input type="hidden" name="theme" id="themeInput" value="{{ theme }}">
        <div class="filter-bar">
            <div style="display: flex; flex-wrap: wrap; gap:10px; align-items: center; flex: 1;">
                             <label>Time:</label>
        <select name="style_date" id="style_date", onchange="updateTimeOptions()">
            <option value="All" {% if selected_style == 'All' %}selected{% endif %}>All</option>
            <option value="Month" {% if selected_style == 'Month' %}selected{% endif %}>Month</option>
            <option value="Quarter" {% if selected_style == 'Quarter'%}selected{% endif %}>Quarter</option>
            <option value="Year" {% if selected_style == 'Year' %}selected{% endif %}>Year</option>
        </select>

        <select name="time_value" id="time_value">
            <option value="{{ selected_time}}">{{ selected_time }}</option>
        </select>


        <label>Region:</label>
        <select name="region">
            {% for r in regions %}
                <option value="{{ r }}" {% if r == selected_region %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
        </select>

        <label>Sale Channel:</label>
        <select name="status">
            {% for s in statuses %}
                <option value="{{ s }}" {% if s == selected_status %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>

        <button type="submit">Filter</button>
        <button type="button" class="btn-reset" onclick="resetFilters()">Reset</button>
        <button type="button" class="btn-export" onclick="exportData()">Export File</button>
            </div>
        <div style="margin-left: auto; font-size:14px; color: #555;" class="time-update">
            <b>The lastest update:</b>{{ current_time }}
        </div>
    </div>
    </form>

    <script>
        function updateTimeOptions(){
            const styleSelect = document.getElementById('style_date');
            const timeSelect = document.getElementById('time_value');
            const value = styleSelect.value;

            timeSelect.innerHTML = ''; //Clear old

            if (value === 'Month') {
                for (let i = 1; i <=12; i++){
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = `Month ${i}`;
                    timeSelect.appendChild(opt);
                }
            } else if (value === 'Quarter') {
                ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                    const opt = document.createElement('option');
                    opt.value = q;
                    opt.text = q;
                    timeSelect.appendChild(opt);
                });
            } else if (value === 'Year') {
                const years = {{ years|tojson }};
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.text = y;
                    timeSelect.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = 'All';
                opt.text = 'All';
                timeSelect.appendChild(opt);
            }
        }
        document.addEventListener("DOMContentLoaded", function(){
            updateTimeOptions();
            document.getElementById("time_value").value = "{{ selected_time}}";
        });

        function resetFilters(){
            document.getElementById('style_date').value = 'All';
            document.getElementById('time_value').innerHTML = "<option value='All'>All</option>";
            document.getElementById('regionSelect').value = 'All';
            document.getElementById('statusSelect').value = 'All';

            window.location.href = "/";
        }

        function exportData() {
            window.location.href = "/export";
        }
        function toggleTheme() {
            const themeSwitch = document.getElementById("theme-switch");
            const isDark = themeSwitch.checked;
            const theme = isDark ? "dark" : "light";
            document.body.className = isDark ? "dark-mode" : "";
            localStorage.setItem("theme", theme);
            document.getElementById("themeInput").value = theme;

            // === C·∫≠p nh·∫≠t theme cho t·∫•t c·∫£ c√°c chart Plotly hi·ªán c√≥ ===
            const layoutUpdate = isDark
                ? {
                    paper_bgcolor: "#121212",
                    plot_bgcolor: "#121212",
                    font: {color: "white"}
                }
                : {
                    paper_bgcolor: "#ffffff",
                    plot_bgcolor: "#ffffff",
                    font: {color: "black"}
                };

            // T√¨m t·∫•t c·∫£ div ch·ª©a chart Plotly
            document.querySelectorAll(".js-plotly-plot").forEach(div => {
                Plotly.relayout(div, layoutUpdate);
            });
        }

        // === Khi load trang ===
        document.addEventListener("DOMContentLoaded", function() {
            const savedTheme = localStorage.getItem("theme") || "light";
            const isDark = savedTheme === "dark";
            document.getElementById("theme-switch").checked = isDark;
            document.body.className = isDark ? "dark-mode" : "";
            document.getElementById("themeInput").value = savedTheme;

            // √Åp d·ª•ng theme ngay cho chart khi reload trang
            const layoutUpdate = isDark
                ? {
                    paper_bgcolor: "#121212",
                    plot_bgcolor: "#121212",
                    font: {color: "white"}
                }
                : {
                    paper_bgcolor: "#ffffff",
                    plot_bgcolor: "#ffffff",
                    font: {color: "black"}
                };
            setTimeout(() => {
                document.querySelectorAll(".js-plotly-plot").forEach(div => {
                    Plotly.relayout(div, layoutUpdate);
                });
            }, 300);
        });
    </script>
    <div class="dashboard-parameters">
  <div class="parameter-card">
    <h5>Total Revenue</h5>
    <p>{{ total_revenue|safe }}</p>
  </div>

  <div class="parameter-card">
    <h5>Total Profit</h5>
    <p>{{ total_profit|safe }}</p>
  </div>

  <div class="parameter-card">
    <h5>Profit Rate</h5>
    <p>{{ profit_rate|safe }}</p>
  </div>

  <div class="parameter-card">
    <h5>Total Cost</h5>
    <p>{{ total_cost|safe }}</p>
  </div>

  <div class="parameter-card">
    <h5>COGs Rate</h5>
    <p>{{ cogs_rate|safe }}</p>
  </div>

  <div class="parameter-card">
    <h5>Average Unit Price</h5>
    <p>{{ avg_unit_price|safe }}</p>
  </div>
</div>

    <div class="dashboard-grid">
            <div class="chart-card">
            {{ chart1|safe }}
        </div>
                <div class="chart-card">
            {{ chart2|safe }}
        </div>
                <div class="chart-card">
            {{ chart3|safe }}
        </div>
                <div class="chart-card">
                <div id="map_chart"></div>
            <script>
                var map_chart = {{graphJSON4|safe}};
                Plotly.newPlot('map_chart', map_chart.data, map_chart.layout);
            </script>
        </div>
                <div class="chart-card">
            {{ chart5|safe }}
        </div>
    </div>  
</body>
</html>
